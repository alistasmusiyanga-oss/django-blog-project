- name: Deploy to EC2
  env:
    PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
    HOST: 44.202.185.227
    USER: ubuntu
    ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
    IMAGE_TAG: ${{ github.sha }}
  run: |
    echo "Deploying to EC2 instance at: $HOST"
    
    # Save private key
    echo "$PRIVATE_KEY" > private_key
    chmod 600 private_key
    
    # Deploy commands
    ssh -o StrictHostKeyChecking=no -i private_key ${USER}@${HOST} "
      set -e
      
      # Update system
      sudo apt update -y
      
      # Install Docker if not installed
      if ! command -v docker &> /dev/null; then
        echo 'Installing Docker...'
        sudo apt install docker.io -y
        sudo systemctl start docker
        sudo systemctl enable docker
        sudo usermod -aG docker ubuntu
        newgrp docker
      fi
      
      # Install AWS CLI if not installed (using pip method)
      if ! command -v aws &> /dev/null; then
        echo 'Installing AWS CLI...'
        sudo apt install python3 python3-pip -y
        pip3 install awscli --upgrade --user
        export PATH=\"\$HOME/.local/bin:\$PATH\"
      fi
      
      echo 'Logging into ECR...'
      aws ecr get-login-password --region us-east-1 | sudo docker login --username AWS --password-stdin $ECR_REGISTRY
      
      # Rest of your deployment commands...
    "
